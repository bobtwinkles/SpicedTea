package tk.sirtwinkles.spicedtea.world.gen.bspdungeon;

public class BSPTree {
	public BSPTree parent, left, right;
	public int x, y, width, height;

	private BSPTree(int width, int height) {
		this.parent = null;
		this.width = width;
		this.height = height;
		this.x = 0;
		this.y = 0;
	}

	private BSPTree(int x, int y, int width, int height, BSPTree parent) {
		this.x = x;
		this.y = y;
		this.width = width;
		this.height = height;
		this.parent = parent;
	}

	public static BSPTree buildTree(int width, int height, int minSize) {
		BSPTree root = new BSPTree(width, height);
		buildTree(root, minSize);
		return root;
	}

	private static void buildTree(BSPTree parent, int minSize) {
		if (Math.random() < 0.5) {
			if (!horiSplit(parent, minSize)) {
				vertSplit(parent, minSize);
			}
		} else {
			if (!vertSplit(parent, minSize)) {
				horiSplit(parent, minSize);
			}
		}
	}
	
	private static boolean horiSplit(BSPTree parent, int minSize) {
		int off = (int) (parent.height * Math.random());
		if (off <= minSize || parent.height - off <= minSize) {
			return false; // We are too small
		}
		BSPTree right = new BSPTree(parent.x, parent.y, parent.width, off,
				parent);
		BSPTree left = new BSPTree(parent.x, parent.y + off, parent.width,
				parent.height - off, parent);
		parent.right = right;
		parent.left = left;
		buildTree(right, minSize);
		buildTree(left, minSize);
		return true;
	}

	private static boolean vertSplit(BSPTree parent, int minSize) {
		if (Math.random() < 0.5) {
			int off = (int) (parent.width * Math.random());
			if (off <= minSize || parent.width - off <= minSize) {
				return false;
			}
			BSPTree right = new BSPTree(parent.x, parent.y, off, parent.height,
					parent);
			BSPTree left = new BSPTree(parent.x + off, parent.y, parent.width
					- off, parent.height, parent);
			parent.right = right;
			parent.left = left;
			buildTree(right, minSize);
			buildTree(left, minSize);
		}
		return false;
	}
}
